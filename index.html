<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Gravar Caminho Sat√©lite</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.5/dist/leaflet.css"/>
<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #map { height: 100%; width: 100%; }
  .controls {
    position: absolute;
    bottom: 10px; left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.95);
    padding: 10px; border-radius: 8px;
    display: flex; flex-wrap: wrap; gap: 10px;
    justify-content: center;
    z-index: 1000;
  }
  button {
    padding: 8px 14px; border: none; border-radius: 5px;
    background: #007bff; color: white; cursor: pointer;
    font-size: 14px;
  }
  button:hover { background: #0056b3; }
  @media (max-width: 400px) {
    button { padding: 6px 10px; font-size: 12px; }
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="controls">
  <button onclick="startTracking()">Iniciar</button>
  <button onclick="stopTracking()">Parar</button>
  <button onclick="printMap()">Print</button>
  <button onclick="shareWhatsApp()">Compartilhar WhatsApp</button>
</div>

<!-- Leaflet e plugins -->
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.5/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-providers@1.13.0/leaflet-providers.min.js"></script>

<script>
// Inicializa mapa
let map = L.map('map').setView([0, 0], 2);

// Mapa sat√©lite via Leaflet Providers (Esri World Imagery)
L.tileLayer.provider('Esri.WorldImagery').addTo(map);

let pathCoords = [];
let pathLine, arrowHead;
let watchId;
let pontoInicial = null;

// Fun√ß√£o Iniciar
function startTracking() {
  pathCoords = [];
  pontoInicial = null;
  if (watchId) navigator.geolocation.clearWatch(watchId);

  if (!navigator.geolocation) {
    alert("Seu navegador n√£o suporta geolocaliza√ß√£o.");
    return;
  }

  watchId = navigator.geolocation.watchPosition(pos => {
    let lat = pos.coords.latitude;
    let lng = pos.coords.longitude;
    let latlng = [lat, lng];

    if (pathCoords.length === 0) {
      pontoInicial = latlng;
      L.marker(latlng).addTo(map)
        .bindPopup(`Ponto Inicial<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`)
        .openPopup();
      map.setView(latlng, 16);
    }

    pathCoords.push(latlng);

    if (pathLine) map.removeLayer(pathLine);
    pathLine = L.polyline(pathCoords, {color: 'blue'}).addTo(map);

    if (arrowHead) map.removeLayer(arrowHead);
    arrowHead = L.polylineDecorator(pathLine, {
      patterns: [{
        offset: 25,
        repeat: 50,
        symbol: L.Symbol.arrowHead({
          pixelSize: 10,
          polygon: false,
          pathOptions: {stroke: true, color: 'red'}
        })
      }]
    }).addTo(map);

  }, err => {
    console.error(err);
    alert("Erro ao capturar localiza√ß√£o. Verifique permiss√µes e HTTPS.");
  }, { enableHighAccuracy: true });
}

// Fun√ß√£o Parar
function stopTracking() {
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    alert(`Caminho gravado!\nPonto Inicial: ${pontoInicial}`);
  }
}

// Print do mapa
function printMap() {
  html2canvas(document.querySelector("#map")).then(canvas => {
    let img = canvas.toDataURL("image/png");
    let newTab = window.open();
    newTab.document.write("<img src='" + img + "' style='width:100%'>");
  });
}

// Compartilhar WhatsApp
function shareWhatsApp() {
  if (!pontoInicial) {
    alert("Inicie o trajeto primeiro!");
    return;
  }
  let lat = pontoInicial[0];
  let lng = pontoInicial[1];
  let link = `https://www.google.com/maps?q=${lat},${lng}`;
  let msg = `üìç Ponto Inicial do Caminho:\nLat: ${lat.toFixed(6)}\nLng: ${lng.toFixed(6)}\nüåç Google Maps: ${link}`;
  let url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
}
</script>
</body>
</html>