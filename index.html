<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gravar Caminho Sat√©lite</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.5/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; }
    .controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px; border-radius: 8px;
      display: flex; flex-direction: column; gap: 5px;
    }
    button {
      padding: 6px 10px; border: none; border-radius: 5px;
      background: #007bff; color: white; cursor: pointer;
    }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <div class="controls">
    <button onclick="startTracking()">Iniciar</button>
    <button onclick="stopTracking()">Parar</button>
    <button onclick="printMap()">Print</button>
    <button onclick="shareWhatsApp()">Compartilhar WhatsApp</button>
  </div>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.5/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    let map = L.map('map').setView([0, 0], 13);

    // Sat√©lite Esri
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles ¬© Esri',
      maxZoom: 19
    }).addTo(map);

    let pathCoords = [];
    let pathLine, arrowHead;
    let watchId;
    let pontoInicial = null;

    function startTracking() {
      pathCoords = [];
      pontoInicial = null;
      if (watchId) navigator.geolocation.clearWatch(watchId);

      watchId = navigator.geolocation.watchPosition(pos => {
        let lat = pos.coords.latitude;
        let lng = pos.coords.longitude;
        let latlng = [lat, lng];

        if (pathCoords.length === 0) {
          pontoInicial = latlng;
          L.marker(latlng).addTo(map).bindPopup("Ponto Inicial<br>Lat: " + lat + "<br>Lng: " + lng).openPopup();
          map.setView(latlng, 16);
        }

        pathCoords.push(latlng);

        if (pathLine) map.removeLayer(pathLine);
        pathLine = L.polyline(pathCoords, {color: 'blue'}).addTo(map);

        if (arrowHead) map.removeLayer(arrowHead);
        arrowHead = L.polylineDecorator(pathLine, {
          patterns: [
            {
              offset: 25,
              repeat: 50,
              symbol: L.Symbol.arrowHead({
                pixelSize: 10,
                polygon: false,
                pathOptions: { stroke: true, color: 'red' }
              })
            }
          ]
        }).addTo(map);

      }, err => console.error(err), { enableHighAccuracy: true });
    }

    function stopTracking() {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        alert("Caminho gravado!\nPonto Inicial: " + pontoInicial);
      }
    }

    function printMap() {
      html2canvas(document.querySelector("#map")).then(canvas => {
        let img = canvas.toDataURL("image/png");
        let newTab = window.open();
        newTab.document.write("<img src='" + img + "' style='width:100%'>");
      });
    }

    function shareWhatsApp() {
      if (!pontoInicial) {
        alert("Inicie o trajeto primeiro!");
        return;
      }
      let lat = pontoInicial[0];
      let lng = pontoInicial[1];
      let link = `https://www.google.com/maps?q=${lat},${lng}`;
      let msg = `üìç Ponto Inicial do Caminho:\nLat: ${lat}\nLng: ${lng}\nüåç Google Maps: ${link}`;
      let url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }
  </script>
</body>
</html>